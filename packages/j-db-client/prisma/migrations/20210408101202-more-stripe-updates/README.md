# Migration `20210408101202-more-stripe-updates`

This migration has been generated by Robin MacPherson at 4/8/2021, 11:12:02 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "MembershipSubscription" ADD COLUMN     "lastFourCardNumbers" TEXT NOT NULL,
ADD COLUMN     "cardType" TEXT NOT NULL,
ADD COLUMN     "lastPaymentFailure" BOOLEAN NOT NULL DEFAULT false

CREATE TABLE "MembershipSubscriptionInvoiceItem" (
"id" SERIAL,
    "chargeCents" INTEGER NOT NULL,
    "chargeCurrency" TEXT NOT NULL,
    "userId" INTEGER NOT NULL,
    "membershipSubscriptionPeriod" "MembershipSubscriptionPeriod" NOT NULL,
    "stripeInvoiceId" TEXT NOT NULL,
    "stripeInvoiceData" JSONB NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

ALTER TABLE "MembershipSubscriptionInvoiceItem" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210403200544-add-stripe-expires-at-end-field..20210408101202-more-stripe-updates
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator prisma_client {
   provider      = "prisma-client-js"
@@ -41,8 +41,9 @@
   postCommentSubscriptions          PostCommentSubscription[]
   PendingNotification               PendingNotification[]
   MembershipSubscriptionTransaction MembershipSubscriptionTransaction[]
   stripeCustomerId                  String?
+  MembershipSubscriptionInvoiceItem MembershipSubscriptionInvoiceItem[]
 }
 model Auth {
   id               Int     @id @default(autoincrement())
@@ -302,15 +303,31 @@
   userId               Int
   stripeSubscription   Json
   stripeSubscriptionId String                       @unique
   cancelAtPeriodEnd    Boolean                      @default(false)
+  lastFourCardNumbers  String
+  cardType             String
+  lastPaymentFailure   Boolean                      @default(false)
   expiresAt            DateTime?
   createdAt            DateTime                     @default(now())
   updatedAt            DateTime                     @updatedAt
   @@unique([userId])
 }
+model MembershipSubscriptionInvoiceItem {
+  id                           Int                          @id @default(autoincrement())
+  chargeCents                  Int
+  chargeCurrency               String
+  user                         User                         @relation(fields: [userId], references: [id])
+  userId                       Int
+  membershipSubscriptionPeriod MembershipSubscriptionPeriod
+  stripeInvoiceId              String
+  stripeInvoiceData            Json
+  createdAt                    DateTime                     @default(now())
+  updatedAt                    DateTime                     @updatedAt
+}
+
 model MembershipSubscriptionTransaction {
   id                           Int                          @id @default(autoincrement())
   chargeCents                  Int
   chargeCurrency               String
```


